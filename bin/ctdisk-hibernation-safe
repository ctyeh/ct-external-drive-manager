#!/bin/bash

# CTExternalDisk Hibernation-Safe Management Tool
# Uses passwordless sudo for fully automatic hibernation handling

SLEEPWATCHER_V2="$HOME/.local/bin/ctdisk-sleepwatcher-v2.sh"
ORIGINAL_CTDISK="$HOME/.local/bin/ctdisk"

show_help() {
    echo "🛡️  CTExternalDisk Hibernation-Safe Management Tool"
    echo ""
    echo "Usage: ctdisk-hibernation-safe [command]"
    echo ""
    echo "Basic Commands:"
    echo "  mount           Mount the external disk"
    echo "  unmount         Safely unmount the external disk"
    echo "  status          Show disk status"
    echo "  check           Check disk health"
    echo ""
    echo "Hibernation-Safe Commands:"
    echo "  sleep-safe      Safely eject disk before hibernation"
    echo "  wake-mount      Remount disk after wake-up"
    echo "  test-sleep      Test hibernation-safe ejection"
    echo "  test-wake       Test wake-up remounting"
    echo "  check-sudo      Verify passwordless sudo configuration"
    echo ""
    echo "System Integration:"
    echo "  setup-hibernation   Set up automatic hibernation handling"
    echo "  remove-hibernation  Remove hibernation handling"
    echo ""
    echo "Features:"
    echo "  🛡️  Passwordless sudo for automatic operation"
    echo "  🔄  Hibernation-safe disk management"
    echo "  ✅  Safe ejection before sleep"
    echo "  🚀  Automatic remounting after wake"
    echo "  📝  Detailed logging of all operations"
    echo ""
}

setup_hibernation_handling() {
    echo "🔧 Setting up automatic hibernation handling..."
    echo ""
    
    # Check if passwordless sudo is configured
    if ! "$SLEEPWATCHER_V2" --check-sudo >/dev/null 2>&1; then
        echo "❌ Passwordless sudo not configured. Please run setup first."
        return 1
    fi
    
    echo "✅ Passwordless sudo verified"
    echo "✅ Sleep/wake handlers ready"
    echo "✅ Hibernation-safe system configured"
    echo ""
    echo "Your CTExternalDisk will now:"
    echo "  • Safely eject before hibernation"
    echo "  • Automatically remount after wake-up"
    echo "  • Handle device node changes"
    echo "  • Maintain iTunes symlink"
    echo ""
    echo "🎉 Hibernation handling is now fully automatic!"
}

case "$1" in
    "sleep-safe")
        echo "🛡️  Preparing CTExternalDisk for hibernation..."
        "$SLEEPWATCHER_V2" --sleep
        ;;
    "wake-mount")
        echo "🚀 Remounting CTExternalDisk after wake-up..."
        "$SLEEPWATCHER_V2" --wake
        ;;
    "test-sleep")
        echo "🧪 Testing hibernation-safe ejection..."
        "$SLEEPWATCHER_V2" --sleep
        ;;
    "test-wake")
        echo "🧪 Testing wake-up remounting..."
        "$SLEEPWATCHER_V2" --wake
        ;;
    "check-sudo")
        "$SLEEPWATCHER_V2" --check-sudo
        ;;
    "setup-hibernation")
        setup_hibernation_handling
        ;;
    "remove-hibernation")
        echo "🗑️  To remove hibernation handling:"
        echo "  sudo rm /etc/sudoers.d/ctexternaldisk-mount"
        echo ""
        echo "This will require manual mounting after hibernation."
        ;;
    "help"|"--help"|"-h")
        show_help
        ;;
    *)
        # Pass through to original ctdisk for basic functionality
        if [ -f "$ORIGINAL_CTDISK" ]; then
            "$ORIGINAL_CTDISK" "$@"
        else
            echo "❌ Original ctdisk command not found"
            show_help
        fi
        ;;
esac
